{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">Welcime back Admin {{ user.username }}</h4>
      <div class="text-muted small">Repair requests and technician workload</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'logout' %}">Logout</a>
    </div>
  </div>

  <!-- Stats row -->
  <div class="row g-3 mb-4">
    <div class="col-md-2 col-6">
      <div class="p-3 border rounded bg-white">
        <div class="text-muted small">Total</div>
        <div class="fw-bold fs-5">{{ total }}</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="p-3 border rounded bg-white">
        <div class="text-muted small">Pending</div>
        <div class="fw-bold fs-5">{{ pending }}</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="p-3 border rounded bg-white">
        <div class="text-muted small">In Progress</div>
        <div class="fw-bold fs-5">{{ in_progress }}</div>
      </div>
    </div>
    <div class="col-md-2 col-6">
      <div class="p-3 border rounded bg-white">
        <div class="text-muted small">Resolved</div>
        <div class="fw-bold fs-5">{{ resolved }}</div>
      </div>
    </div>
    <div class="col-md-4 col-12">
      <div class="p-3 border rounded bg-white">
        <div class="text-muted small">Unassigned</div>
        <div class="fw-bold fs-5">{{ unassigned }}</div>
        <div class="text-muted small">Requests waiting for assignment</div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Requests table -->
    <div class="col-lg-8">
      <div class="border rounded bg-white p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">All Requests</h6>
          <span class="text-muted small">Latest first</span>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr class="text-muted small">
                <th>ID</th>
                <th>Employee</th>
                <th>Status</th>
                <th>Technician</th>
                <th>Created</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in all_requests %}
              <tr>
                <td>#{{ r.id }}</td>
                <td>{{ r.employee }}</td>
                <td>
                  <span class="badge
                    {% if r.status == 'Resolved' %} text-bg-success
                    {% elif r.status == 'In Progress' %} text-bg-warning
                    {% else %} text-bg-secondary
                    {% endif %}">
                    {{ r.status }}
                  </span>
                </td>
                <td>
                  {% if r.technician %}
                    {{ r.technician }}
                  {% else %}
                    <span class="text-muted">Unassigned</span>
                  {% endif %}
                </td>
                <td class="text-muted small">{{ r.created_at|date:"M d, Y" }}</td>
                <td class="text-end">
                  <a class="btn btn-outline-primary btn-sm" href="{% url 'view_request_details' r.id %}">
                    View
                  </a>
                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'update_request_status' r.id %}">
                    Update
                  </a>
                  <a class="btn btn-outline-success btn-sm" href="{% url 'assign_request' r.id %}">Assign</a>

                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">No requests yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Technician performance -->
    <div class="col-lg-4">
      <div class="border rounded bg-white p-3">
        <h6 class="mb-2">Technician Workload</h6>
        <div class="text-muted small mb-3">Assigned tasks per technician</div>

        <ul class="list-group list-group-flush">
          {% for t in technician_perfomance %}
          <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span>{{ t.user.username }}</span>
            <span class="badge text-bg-light border">{{ t.assigned_tasks }}</span>
          </li>
          {% empty %}
          <li class="list-group-item text-muted px-0">No technicians found.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

  </div>
</div>
{% endblock %}
